# ğŸ›ï¸ Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PRESENTATION LAYER                            â”‚
â”‚                                   (UI)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Admin UI   â”‚  â”‚ Customer UI  â”‚  â”‚  Staff UI    â”‚  â”‚  Shared UI   â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ - AdminView  â”‚  â”‚ - Customer   â”‚  â”‚ - StaffView  â”‚  â”‚ - MemberInfo â”‚  â”‚
â”‚  â”‚ - AdminPass  â”‚  â”‚   View       â”‚  â”‚              â”‚  â”‚   Card       â”‚  â”‚
â”‚  â”‚   Dialog     â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ - Role       â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚   Switcher   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                 â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                           â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         Dialog Components                           â”‚  â”‚
â”‚  â”‚                    - PinVerificationDialog                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Uses
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              BUSINESS LAYER                                â”‚
â”‚                            (Manager + State)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         AppState             â”‚      â”‚   PinVerificationManager     â”‚   â”‚
â”‚  â”‚    (core/state)              â”‚      â”‚      (manager/pin)           â”‚   â”‚
â”‚  â”‚                              â”‚      â”‚                              â”‚   â”‚
â”‚  â”‚ - Current role               â”‚â—„â”€â”€â”€â”€â–ºâ”‚ - PIN verification logic     â”‚   â”‚
â”‚  â”‚ - Scanned members            â”‚      â”‚ - Attempts tracking          â”‚   â”‚
â”‚  â”‚ - Cart, transactions         â”‚      â”‚ - Auto lock on failure       â”‚   â”‚
â”‚  â”‚ - Locked cards set           â”‚      â”‚ - Reset on admin unlock      â”‚   â”‚
â”‚  â”‚                              â”‚      â”‚                              â”‚   â”‚
â”‚  â”‚ Business Logic:              â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ - scan()                     â”‚                     â”‚                   â”‚
â”‚  â”‚ - adminScan()                â”‚                     â”‚                   â”‚
â”‚  â”‚ - processPayment()           â”‚                     â”‚                   â”‚
â”‚  â”‚ - unlockCard()               â”‚                     â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚                   â”‚
â”‚                 â”‚                                     â”‚                   â”‚
â”‚                 â”‚ Delegates to                        â”‚ Delegates to      â”‚
â”‚                 â–¼                                     â–¼                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CORE SERVICE LAYER                               â”‚
â”‚                            (Smartcard I/O)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚    SmartcardService          â”‚  â—„â”€â”€ Interface (Dependency Inversion)   â”‚
â”‚  â”‚       (Interface)            â”‚                                         â”‚
â”‚  â”‚                              â”‚                                         â”‚
â”‚  â”‚ - createCard()               â”‚                                         â”‚
â”‚  â”‚ - insertCard()               â”‚                                         â”‚
â”‚  â”‚ - ejectCard()                â”‚                                         â”‚
â”‚  â”‚ - verifyPin()                â”‚                                         â”‚
â”‚  â”‚ - readCardData()             â”‚                                         â”‚
â”‚  â”‚ - updateBalance()            â”‚                                         â”‚
â”‚  â”‚ - changePin()                â”‚                                         â”‚
â”‚  â”‚ - unlockCard()               â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                 â”‚                                                          â”‚
â”‚                 â”‚ Implemented by                                           â”‚
â”‚                 â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              JCardSimService (Implementation)                        â”‚ â”‚
â”‚  â”‚                  (core/smartcard)                                    â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚ Registries:                                                          â”‚ â”‚
â”‚  â”‚ - cardRegistry:          Map<MemberId, CardSimulator>                â”‚ â”‚
â”‚  â”‚ - saltRegistry:          Map<MemberId, Salt>                         â”‚ â”‚
â”‚  â”‚ - encryptedDataRegistry: Map<MemberId, EncryptedCardData>            â”‚ â”‚
â”‚  â”‚ - memberInfoRegistry:    Map<MemberId, Member>  â† For dropdown       â”‚ â”‚
â”‚  â”‚ - verifiedPINRegistry:   Map<MemberId, PIN>     â† Session only       â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚ APDU Commands:                                                       â”‚ â”‚
â”‚  â”‚ - INS_VERIFY_PIN (0x20)                                              â”‚ â”‚
â”‚  â”‚ - INS_READ_DATA  (0x30)                                              â”‚ â”‚
â”‚  â”‚ - INS_UPDATE_BALANCE (0x40)                                          â”‚ â”‚
â”‚  â”‚ - INS_CHANGE_PIN (0x50)                                              â”‚ â”‚
â”‚  â”‚ - INS_SET_DATA   (0x60)                                              â”‚ â”‚
â”‚  â”‚                                                                      â”‚ â”‚
â”‚  â”‚ Security Flow:                                                       â”‚ â”‚
â”‚  â”‚ 1. Generate Salt (createCard)                                        â”‚ â”‚
â”‚  â”‚ 2. PIN + Salt â†’ PBKDF2 â†’ AES-256 Key                                 â”‚ â”‚
â”‚  â”‚ 3. Member Data â†’ AES-GCM Encrypt â†’ Store                             â”‚ â”‚
â”‚  â”‚ 4. On Read: Verify PIN â†’ Derive Key â†’ Decrypt                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚                                         â”‚
â”‚                                 â”‚ Uses                                    â”‚
â”‚                                 â–¼                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SECURITY LAYER                                  â”‚
â”‚                        (Encryption & Hashing)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    AESEncryptionManager            â”‚  â”‚ CardDataEncryptionManager    â”‚ â”‚
â”‚  â”‚       (security/)                  â”‚  â”‚      (security/)             â”‚ â”‚
â”‚  â”‚                                    â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ Low-level AES operations:          â”‚  â”‚ High-level Member crypto:    â”‚ â”‚
â”‚  â”‚                                    â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ - generateKeyFromPIN()             â”‚â—„â”€â”¤ - encryptMemberData()        â”‚ â”‚
â”‚  â”‚   â†’ PBKDF2-HMAC-SHA256             â”‚  â”‚   â†’ Member â†’ Encrypted       â”‚ â”‚
â”‚  â”‚   â†’ 10,000 iterations              â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚   â†’ 256-bit key                    â”‚  â”‚ - decryptMemberData()        â”‚ â”‚
â”‚  â”‚                                    â”‚  â”‚   â†’ Encrypted â†’ Member       â”‚ â”‚
â”‚  â”‚ - generateSalt()                   â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚   â†’ 16-byte random                 â”‚  â”‚ Handles all fields:          â”‚ â”‚
â”‚  â”‚                                    â”‚  â”‚ - fullName                   â”‚ â”‚
â”‚  â”‚ - encrypt() / decrypt()            â”‚  â”‚ - birthDate                  â”‚ â”‚
â”‚  â”‚   â†’ AES-256-GCM                    â”‚  â”‚ - cccdNumber                 â”‚ â”‚
â”‚  â”‚   â†’ Random IV per operation        â”‚  â”‚ - photoPath                  â”‚ â”‚
â”‚  â”‚   â†’ Authenticated encryption       â”‚  â”‚ - balance                    â”‚ â”‚
â”‚  â”‚                                    â”‚  â”‚ - dates, packageType         â”‚ â”‚
â”‚  â”‚ - encryptString()                  â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ - encryptLong()                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚ - decryptString()                  â”‚                                   â”‚
â”‚  â”‚ - decryptLong()                    â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DATA LAYER                                    â”‚
â”‚                            (Models & DTOs)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Member    â”‚  â”‚  CartItem   â”‚  â”‚ Transaction â”‚  â”‚ EncryptedCard    â”‚ â”‚
â”‚  â”‚   (model)   â”‚  â”‚   (model)   â”‚  â”‚   (model)   â”‚  â”‚ Data (security)  â”‚ â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚ - memberId  â”‚  â”‚ - name      â”‚  â”‚ - type      â”‚  â”‚ - memberId       â”‚ â”‚
â”‚  â”‚ - fullName  â”‚  â”‚ - price     â”‚  â”‚ - amount    â”‚  â”‚ - encryptedData  â”‚ â”‚
â”‚  â”‚ - birthDate â”‚  â”‚ - quantity  â”‚  â”‚ - old/new   â”‚  â”‚   fields         â”‚ â”‚
â”‚  â”‚ - cccdNum   â”‚  â”‚             â”‚  â”‚   Balance   â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚ - photoPath â”‚  â”‚             â”‚  â”‚ - timestamp â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚ - balance   â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚ - package   â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚ - dates     â”‚  â”‚             â”‚  â”‚             â”‚  â”‚                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚  â”‚    Role     â”‚                                                          â”‚
â”‚  â”‚   (enum)    â”‚                                                          â”‚
â”‚  â”‚             â”‚                                                          â”‚
â”‚  â”‚ - ADMIN     â”‚                                                          â”‚
â”‚  â”‚ - STAFF     â”‚                                                          â”‚
â”‚  â”‚ - CUSTOMER  â”‚                                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          DEPENDENCY FLOW                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                            â•‘
â•‘  UI Layer                                                                  â•‘
â•‘      â”‚ depends on                                                          â•‘
â•‘      â–¼                                                                     â•‘
â•‘  Business Layer (AppState + Managers)                                      â•‘
â•‘      â”‚ depends on                                                          â•‘
â•‘      â–¼                                                                     â•‘
â•‘  Core Service Layer (SmartcardService Interface)                           â•‘
â•‘      â”‚ implemented by                                                      â•‘
â•‘      â–¼                                                                     â•‘
â•‘  JCardSimService (uses Security Layer)                                     â•‘
â•‘      â”‚ depends on                                                          â•‘
â•‘      â–¼                                                                     â•‘
â•‘  Security Layer (AES/PBKDF2)                                               â•‘
â•‘      â”‚ operates on                                                         â•‘
â•‘      â–¼                                                                     â•‘
â•‘  Data Layer (Models)                                                       â•‘
â•‘                                                                            â•‘
â•‘  âœ… No circular dependencies                                               â•‘
â•‘  âœ… Testable in isolation                                                  â•‘
â•‘  âœ… Easy to swap implementations                                           â•‘
â•‘                                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ENCRYPTION FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [CREATE CARD]                                                  â”‚
â”‚                                                                 â”‚
â”‚  1. User enters PIN (e.g., "1234")                             â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚  2. Generate Random Salt (16 bytes)                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ Salt: 3a7f9c2e1b...            â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚  3. PBKDF2-HMAC-SHA256                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ PIN + Salt                     â”‚                         â”‚
â”‚     â”‚ â†’ 10,000 iterations            â”‚                         â”‚
â”‚     â”‚ â†’ 256-bit AES Key              â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚  4. AES-256-GCM Encrypt Member Data                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ Member Object:                 â”‚                         â”‚
â”‚     â”‚ - fullName: "Nguyá»…n VÄƒn A"     â”‚                         â”‚
â”‚     â”‚ - balance: 500000              â”‚                         â”‚
â”‚     â”‚ - birthDate: 1990-01-01        â”‚                         â”‚
â”‚     â”‚ - cccdNumber: 001234567890     â”‚                         â”‚
â”‚     â”‚         â”‚                       â”‚                         â”‚
â”‚     â”‚         â–¼                       â”‚                         â”‚
â”‚     â”‚ Encrypted with random IV       â”‚                         â”‚
â”‚     â”‚ â†’ EncryptedCardData            â”‚                         â”‚
â”‚     â”‚   {memberId, fields{...}}      â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚  5. Store in Registries                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ saltRegistry[memberId] = salt  â”‚                         â”‚
â”‚     â”‚ encryptedDataRegistry[id] = e  â”‚                         â”‚
â”‚     â”‚ memberInfoRegistry[id] = m     â”‚â—„â”€â”€ Unencrypted for UI  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [READ CARD WITH PIN]                                           â”‚
â”‚                                                                 â”‚
â”‚  1. User scans card & enters PIN                               â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚  2. Verify PIN on applet (APDU)                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ Success â†’ Store in             â”‚                         â”‚
â”‚     â”‚ verifiedPINRegistry[id] = PIN  â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚  3. Retrieve Salt                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ salt = saltRegistry[memberId]  â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚  4. Re-derive AES Key                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ Verified PIN + Salt            â”‚                         â”‚
â”‚     â”‚ â†’ PBKDF2 (same params)         â”‚                         â”‚
â”‚     â”‚ â†’ Same 256-bit AES Key         â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚  5. Decrypt Card Data                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚ encrypted = encryptedData[id]  â”‚                         â”‚
â”‚     â”‚         â”‚                       â”‚                         â”‚
â”‚     â”‚         â–¼                       â”‚                         â”‚
â”‚     â”‚ AES-256-GCM Decrypt            â”‚                         â”‚
â”‚     â”‚         â”‚                       â”‚                         â”‚
â”‚     â”‚         â–¼                       â”‚                         â”‚
â”‚     â”‚ Member Object (plain)          â”‚                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [SECURITY ON EJECT]                                            â”‚
â”‚                                                                 â”‚
â”‚  â€¢ verifiedPINRegistry[id] deleted                             â”‚
â”‚  â€¢ Force re-verify PIN on next insert                          â”‚
â”‚  â€¢ Encrypted data remains in encryptedDataRegistry             â”‚
â”‚  â€¢ Salt remains (needed for next decrypt)                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Key Security Features

1. **PBKDF2-HMAC-SHA256**: Industry standard key derivation (NIST SP 800-132)
2. **10,000 iterations**: Slow down brute-force attacks
3. **Random Salt per card**: Prevent rainbow table attacks
4. **AES-256-GCM**: Authenticated encryption (integrity + confidentiality)
5. **Random IV per encrypt**: Same plaintext â†’ different ciphertext
6. **Session-based PIN**: Cleared on eject, must re-verify
7. **Attempt tracking**: Lock card after 3 failures
8. **Separate registries**: Encrypted storage vs. UI display data

